<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .rounded-card { border-radius: 20px; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .chat-bubble-me { background: #0084ff; color: white; border-radius: 18px 18px 4px 18px; }
        .chat-bubble-them { background: #e4e6eb; color: black; border-radius: 18px 18px 18px 4px; }
    </style>
</head>
<body class="h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-md h-[90vh] glass shadow-2xl overflow-hidden flex flex-col rounded-card relative">
        
        <header class="p-4 bg-white border-b flex justify-between items-center">
            <div>
                <h1 class="font-bold text-xl">Meine Chats</h1>
                <p class="text-xs text-gray-500">Deine ID: <span id="my-id" class="font-mono font-bold text-blue-600">Lade...</span></p>
            </div>
            <button onclick="toggleModal(true)" class="bg-blue-100 text-blue-600 p-2 rounded-full hover:bg-blue-200 transition">
                <i class="fas fa-plus"></i>
            </button>
        </header>

        <div id="contact-list" class="flex-1 overflow-y-auto p-2">
            </div>

        <div id="chat-window" class="absolute inset-0 bg-white z-20 hidden flex flex-col">
            <div class="p-4 border-b flex items-center bg-gray-50">
                <button onclick="closeChat()" class="mr-3 text-gray-600"><i class="fas fa-arrow-left"></i></button>
                <div class="flex-1 cursor-pointer" onclick="openProfileEdit()">
                    <h2 id="chat-partner-name" class="font-bold">Name</h2>
                    <p id="chat-partner-id" class="text-xs text-gray-400 font-mono"></p>
                </div>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-3"></div>
            <div class="p-4 border-t flex gap-2">
                <input id="msg-input" type="text" placeholder="Nachricht..." class="flex-1 p-2 border rounded-full outline-none px-4">
                <button onclick="sendMessage()" class="bg-blue-600 text-white p-2 rounded-full w-10 h-10"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="modal" class="absolute inset-0 bg-black/50 z-30 hidden flex items-center justify-center p-6">
            <div class="bg-white w-full p-6 rounded-3xl">
                <h3 class="font-bold text-lg mb-4">Neuen Kontakt hinzufügen</h3>
                <input id="new-contact-id" type="text" placeholder="Partner ID eingeben" class="w-full p-3 border rounded-xl mb-4 outline-none">
                <div class="flex gap-2">
                    <button onclick="addContact()" class="flex-1 bg-blue-600 text-white py-2 rounded-xl">Hinzufügen</button>
                    <button onclick="toggleModal(false)" class="flex-1 bg-gray-200 py-2 rounded-xl">Abbrechen</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot, collection, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // 111
        // Füge hier deinen Firebase Config Block ein!
        const firebaseConfig = {
        apiKey: "AIzaSyCLl89wXVm2vCYsZJZoiZ1YVsGeH87TjHU", authDomain: "messanger-af5fb.firebaseapp.com", projectId: "messanger-af5fb", storageBucket: "messanger-af5fb.firebasestorage.app", messagingSenderId: "867510097566", appId: "1:867510097566:web:78bcb5393e4b44aa374d8f"
        };
        // 111

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let activeChatId = null;
        let activePartnerId = null;

        // Login & ID Generierung
        signInAnonymously(auth).catch(console.error);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('my-id').innerText = user.uid.substring(0, 8);
                loadContacts();
            }
        });

        // UI Helfer
        window.toggleModal = (show) => document.getElementById('modal').classList.toggle('hidden', !show);
        window.closeChat = () => document.getElementById('chat-window').classList.add('hidden');

        // Kontakt hinzufügen
        window.addContact = async () => {
            const id = document.getElementById('new-contact-id').value.trim();
            if (!id) return;
            const userRef = doc(db, "users", currentUser.uid);
            await setDoc(userRef, { contacts: arrayUnion(id) }, { merge: true });
            toggleModal(false);
            loadContacts();
        };

        // Kontakte laden
        async function loadContacts() {
            const userRef = doc(db, "users", currentUser.uid);
            const userSnap = await getDoc(userRef);
            const list = document.getElementById('contact-list');
            list.innerHTML = "";

            if (userSnap.exists() && userSnap.data().contacts) {
                userSnap.data().contacts.forEach(contactId => {
                    const customName = localStorage.getItem('alias_' + contactId) || "Kontakt " + contactId.substring(0, 4);
                    const div = document.createElement('div');
                    div.className = "p-4 border-b hover:bg-gray-50 cursor-pointer flex items-center gap-3 transition";
                    div.innerHTML = `<div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">${customName[0]}</div>
                                     <div><p class="font-bold">${customName}</p><p class="text-xs text-gray-400">ID: ${contactId}</p></div>`;
                    div.onclick = () => openChat(contactId, customName);
                    list.appendChild(div);
                });
            }
        }

        // Chat öffnen
        window.openChat = (partnerId, name) => {
            activePartnerId = partnerId;
            document.getElementById('chat-partner-name').innerText = name;
            document.getElementById('chat-partner-id').innerText = partnerId;
            document.getElementById('chat-window').classList.remove('hidden');
            
            // Chat-Raum ID generieren (Immer alphabetisch sortiert für Konsistenz)
            activeChatId = [currentUser.uid, partnerId].sort().join("_");
            listenToMessages();
        };

        // Nachrichten hören
        function listenToMessages() {
            const q = query(collection(db, "chats", activeChatId, "messages"), orderBy("time", "asc"));
            onSnapshot(q, (snapshot) => {
                const box = document.getElementById('messages');
                box.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isMe = data.sender === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `max-w-[80%] p-3 ${isMe ? 'self-end chat-bubble-me' : 'self-start chat-bubble-them'}`;
                    div.innerText = data.text;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // Nachricht senden
        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            await addDoc(collection(db, "chats", activeChatId, "messages"), {
                text: text,
                sender: currentUser.uid,
                time: Date.now()
            });
            input.value = "";
        };

        // Profil anklicken zum Umbenennen
        window.openProfileEdit = () => {
            const newName = prompt("Wie möchtest du diesen Kontakt nennen?");
            if (newName) {
                localStorage.setItem('alias_' + activePartnerId, newName);
                document.getElementById('chat-partner-name').innerText = newName;
                loadContacts();
            }
        };
    </script>
</body>
</html>
